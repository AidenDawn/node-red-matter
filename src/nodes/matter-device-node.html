<script type="module">
  const name = 'matter-device';
  RED.nodes.registerType(name, {
    category: 'config',
    color: '#a6bbcf',
    defaults: {
      name: { value: '' },
      devicetype: {
        value: 'OnOffLightDevice',
        required: true,
        validate: RED.validators.regex(
          /^(OnOffLightDevice|OnOffPluginUnitDevice)$/
        ),
      },
      port: {
        value: '0',
        required: true,
        validate: RED.validators.number(),
        type: 'number',
      },
      discriminator: {
        type: 'number',
        validate: (value) => {
          if (value < 0 || value > 4095) {
            return false;
          }
          return true;
        },
      },
    },
    icon: 'matter-logo.svg',
    label: function () {
      return this.name || 'Matter Device';
    },
    oneditprepare: function () {
      const discriminatorInput = document.getElementById(
        'node-config-input-discriminator'
      );
      if (discriminatorInput.value === '') {
        discriminatorInput.value = Math.floor(Math.random() * 4096);
      }

      $.getJSON(
        `node-red-matter/pairingcode?device-id=${this.id}`,
        function (data) {
          document.getElementById(
            'node-config-input-devicetype'
          ).disabled = true;
          document.getElementById('node-config-pairing').hidden = false;
          document.getElementById('node-config-notready').hidden = true;
          document.getElementById('node-config-input-pairing').innerText =
            data.qrcode;

          document.getElementById('node-config-input-manual-pairing').value =
            data.manualPairingCode;
        }
      );
    },
  });
</script>

<script type="text/html" data-template-name="matter-device">
  <div class="form-row">
    <label for="node-config-input-name">Name</label>
    <input type="text" id="node-config-input-name" placeholder="Name" />
  </div>

  <div class="form-row">
    <label for="node-config-input-devicetype">Device Type</label>
    <select id="node-config-input-devicetype">
      <option value="OnOffLightDevice">On/Off Light</option>
      <option value="OnOffPluginUnitDevice">On/Off Plug</option>
    </select>
  </div>

  <div class="form-row">
    <label for="node-config-input-port">UDP Port</label>
    <input
      type="number"
      id="node-config-input-port"
      placeholder="UDP Port Number"
    />
  </div>

  <p>Leave this 0 to let the node pick a random free port number.</p>

  <div class="form-row">
    <label for="node-config-input-discriminator">Discriminator</label>
    <input type="text" id="node-config-input-discriminator" />
  </div>

  <h3>Pairing</h3>
  <p id="node-config-notready">
    To generate a pairing code, deploy this node first.
  </p>
  <div id="node-config-pairing" hidden>
    <p>
      Scan the QR code in your Matter controller app (Apple Home, Google Home,
      Alexa, etc...) to pair this device. We suggest to give this device the
      same name as this node to make it easier to find it later.
    </p>
    <div class="form-row">
      <label for="node-config-input-pairing">
        <i class="fa fa-qrcode"></i> QR Code
      </label>
      <pre style="line-height: 1" id="node-config-input-pairing"></pre>
    </div>
    <div class="form-row">
      <label for="node-config-input-manual-pairing">
        <i class="fa fa-key"></i> Code
      </label>
      <input type="text" id="node-config-input-manual-pairing" readonly />
    </div>
  </div>
</script>

<script type="text/html" data-help-name="matter-device">
  <p>
    Generates a virtual Matter device that can be paired with a Matter
    controller app (Apple Home, Google Home, Alexa, etc...). The device can be
    read and/or controlled by other nodes in Node-RED.
  </p>
</script>
